<!DOCTYPE html>
    <html>

    <head>
        <meta charset="utf-8" />
        <meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
        <meta name=apple-mobile-web-app-capable content=yes>
        <meta name=apple-mobile-web-app-status-bar-style content=black>
        <title>Property Inspector Event Master recallCue</title>
        <link rel="stylesheet" href="../css/sdpi.css">
        <!--link rel="stylesheet" 
              media="screen and (max-width: 1025px)" 
              href="css/local.css" -->
         <link rel="stylesheet" href="../css/local.css">

    </head>

    <body>
        <div class="sdpi-wrapper localbody hiddenx">
            <div class="sdpi-item" id="ip_address" title="This field lets you enter an IP-Adress. The little exclamation mark changes to a checkmark, if the condition is met (e.g. you entered an IP-address.).">
                <div class="sdpi-item-label">IP Address</div> 
                <input id="setValue_iPAddress" class="sdpi-item-value" value="" placeholder="e.g. 192.168.61.1" required pattern="\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}" oninput="updateSettings()">
            </div>
            <div class="sdpi-item" id="port" title="This field lets you enter the port number. The little exclamation mark changes to a checkmark, if the condition is met (e.g. you entered an IP-address.).">
                <div class="sdpi-item-label">Port</div> 
                <input id="setValue_port" class="sdpi-item-value" value="" placeholder="e.g. 9999" required pattern="\d{1,5}" oninput="updateSettings()">
            </div>
            <div class="sdpi-item" id="selected_cue">
                <div class="sdpi-item-label">Available Cues</div>
                <select class="sdpi-item-value select" onchange="updateSettings()">
                    <option value="">Retreiving Cues...</option>
                </select>
            </div>
            <div type="radio" class="sdpi-item">
                <div class="sdpi-item-label">Action</div>
                <div class="sdpi-item-value ">
                    <div class="sdpi-item-child">
                        <input id="play_radio" type="radio" value="play" name="radio_cue_mode" checked onchange="updateSettings()" >
                        <label for="play_radio" class="sdpi-item-label"><span></span>Play</label>
                    </div>
                    <div class="sdpi-item-child">
                        <input id="stop_radio" type="radio" value="stop" name="radio_cue_mode" onchange="updateSettings()">
                        <label for="stop_radio class="sdpi-item-label"><span></span>Stop</label>
                    </div>
                </div>
            </div>
            <div class="sdpi-item">
                <div class="sdpi-item-label">Status</div>
                <div class="sdpi-item-value">
                    <span class="sdpi-item-child statusText">
                        Cannot detect Event Master on the the network
                    </span>
                </div>
            </div>


        </div>
        
        <script>
           
            function loadAction() {
                websocket.onmessage = function (evt) {
                    // Received message from Stream Deck
                    var jsonObj = JSON.parse(evt.data);

                    if (jsonObj.event === 'sendToPropertyInspector') {
                        var cue_selection = document.getElementById('selected_cue');
                        cue_selection.style.display = "none";

                        var payload = jsonObj.payload;
                        if (checkForErrors(payload)) {
                            return;
                        }

                        cue_selection.style.display = "";

                        // Save the payload
                        ipAddress = payload.ipAddress;
                        host = payload.host;
                        cues = payload.cues;
                        selectedCue = payload.selectedCue;
                        cueMode = payload.cueMode;
                        
                        var selectCueDiv = document.getElementById('selected_cue');
                        var selectCue = selectCueDiv.querySelector('.sdpi-item-value');
                        removeOptions(selectCue);

                        var curGroupName;
                        for (var index = 0; index < commands.length; index++) {
                            if (curGroupName !== commands[index].Category) {
                                curGroupName = commands[index].Category;

                                var curGroup = document.createElement('option');
                                curGroup.text = curGroupName;
                                curGroup.value = curGroupName;
                                selectCategory.appendChild(curGroup);
                            }
                        }

                        var argsDiv = document.getElementById('arguments');
                        var args = argsDiv.querySelector('.sdpi-item-value');
                        args.value = payload.arguments;

                        selectCategory.disabled = false;
                        args.disabled = false;

                        refreshSelectedCues();
                    }
                };
            }
    
            function updateSetttings() {
                var ipAddressDiv = document.getElementById('ip_address');
                var ipAddress = ipAddressDiv.querySelector('.sdpi-item-value');

                var portDiv = document.getElementById('port');
                var port = portDiv.querySelector('.sdpi-item-value');

                var cueDiv = document.getElementById('selected_cue');
                var cue = portDiv.querySelector('.sdpi-item-value');

                var cueDiv = document.getElementById('selected_cue');
                var cue = portDiv.querySelector('.sdpi-item-value');

                var cueModeRadioButtons = document.getElementByName('radio_cue_mode');
                var cueMode = "play";
                for(var i=0; i< cueModeRadioButtons.length; i++ ) {
                    if( cueModeRadioButtons[i].checked == true) {
                        cueMode = cueModeRadioButtons.value
                    }
                }

                var payload = {};
                payload.property_inspector = 'updateSettings';
                payload.ipAddress = ipAddress.value;
                payload.port = port.value;
                payload.cue = cue.value;
                playload.cueMode = cueMode;

                sendPayloadToPlugin(payload);
            }

            function updateStatus() {
    
                console.log("updateStatus: " + appStatus);
    
                //show lists and selectors and hide download button
                const labelStatus = document.querySelector('.statusText');

                if (appStatus == "disconnected")
                    labelStatus.innerHTML = "Cannot detect Event Master on the network";

                else if (appStatus == "connected")
                    labelStatus.innerHTML = "Event Master is detected on the network";

                labelStatus.innerHTML = labelStatus.innerHTML.replace(labelStatus.innerText, localize(labelStatus.innerText));
            }
    
            function refreshSelectedCues(jsonListOfCues) {
    
                //remove all option list
                const oCuesSelector = document.getElementById("selected_cue");
                
                for(var i = oCuesSelector.options.length - 1 ; i >= 0 ; i--) {
                    oCuesSelector.remove(i);
                }
    
                var opt = document.createElement('option');
    
                opt.value = "";
                opt.innerHTML = "(Select a cue from the list)";
                oCuesSelector.appendChild(opt);
    
                //load the list of cues
                for (i = 0; i < jsonListOfCues.length; i++) {
                    opt = document.createElement('option');
    
                    opt.value = jsonListOfCues[i].cueID;
                    opt.innerHTML = jsonListOfCues[i].friendlyName;
    
                    if (cue_selected != "" && cue_selected == jsonListOfCues[i].cueID) {
                        opt.selected = true;
                    }
    
                    oCuesSelector.appendChild(opt);
                }
    
    
            }
    
            function messageFromPlugin(jsonObj) {
    
                console.log(jsonObj);
    
                if (jsonObj && jsonObj.payload && jsonObj.payload.command) {
    
                    if ( jsonObj.payload.command == "getData") {
                        
                        //get settings
                        if (jsonObj.payload.settings) {
                            var settings = jsonObj.payload.settings;
    
                            // IP Address
                            if (settings.hasOwnProperty("ip_address"))
                                ip_address  = settings.ip_address;

                            // Host
                            if (settings.hasOwnProperty("port"))
                                port  = settings.port;
                            
                            // Cues
                            if (settings.hasOwnProperty("cue_selected"))
                                cue_selected = settings.cue_selected;
                        }
    
                        //cues
                        if (jsonObj.payload.cues && jsonObj.payload.cues.actionObject) {
    
                            listOfCues = jsonObj.payload.cues.actionObject;
    
                            reloadListOfCues(listOfCues);
    
                            showHideFilterType("show");
                        }
    
                        //appStatus
                        if (jsonObj.payload.appStatus) {
                            appStatus = jsonObj.payload.appStatus;
    
                            updateStatus();
                        } 
    
                    }
    
                }
    
            }
    
    
            function sendMessageToPlugin(action, value) {
    
                //console.log("send Message to Plugin: ", action, value, uuid, pluginAction);
    
                if ($SD && $SD.connection) {
                    var payload = {};                
                    if (action) {
    
                        if (action == "setSettings") {
    
                           ip_address = payload["ip_address"] = getIPAddress();
                           port = payload["ip_address"] = getPort();
                           cue_selected = payload["cue_selected"] = value;
                           payload["command"] = action;
                        }
    
                        if (action == "getData") {
    
                            payload["command"] = action;
                        }
    
                        $SD.api.sendToPlugin(uuid, pluginAction, payload);
                    }
                }
            }
    
    
            function localize (s) {
                if (Utils.isUndefined(s)) return '';
                let str = String(s);
                try {
                    str = $localizedStrings[str] || str;
                } catch (b) {}
                return str;
            };
    
            function _e (s) {
                return localize(s);
            }
    
            function localizeUI() {
                const el = document.querySelector('.sdpi-wrapper');
                Array.from(el.querySelectorAll('sdpi-item-label')).forEach(e => {
                    e.innerHTML = e.innerHTML.replace(e.innerText, localize(e.innerText));
                });
                Array.from(el.querySelectorAll('*:not(script)')).forEach(e => {  
                    if (e.childNodes && e.childNodes.length > 0 && e.childNodes[0].nodeValue && typeof e.childNodes[0].nodeValue === 'string') {
                        e.childNodes[0].nodeValue = localize(e.childNodes[0].nodeValue);
                    }
                });
            }
            
            
        </script>
    </body>

    </html>
