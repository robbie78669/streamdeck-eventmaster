<!DOCTYPE html>
    <html>

    <head>
        <meta charset="utf-8" />
        <meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
        <meta name=apple-mobile-web-app-capable content=yes>
        <meta name=apple-mobile-web-app-status-bar-style content=black>
        <title>Property Inspector Samples PI</title>
        <link rel="stylesheet" href="css/sdpi.css">
        <!--link rel="stylesheet" 
              media="screen and (max-width: 1025px)" 
              href="css/local.css" -->
         <link rel="stylesheet" href="css/local.css">

    </head>

    <body>
        <div class="sdpi-wrapper localbody hiddenx">
            <div class="sdpi-item" id="ip_address" title="This field lets you enter an IP-Adress. The little exclamation mark changes to a checkmark, if the condition is met (e.g. you entered an IP-address.).">
                <div class="sdpi-item-label">IP Address</div> 
                <input id="ip_address" class="sdpi-item-value" value="" placeholder="e.g. 192.168.61.1" required pattern="\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}">
            </div>
            <div class="sdpi-item" id="port" title="This field lets you enter the port number. The little exclamation mark changes to a checkmark, if the condition is met (e.g. you entered an IP-address.).">
                <div class="sdpi-item-label">Port</div> 
                <input id="port" class="sdpi-item-value" value="" placeholder="e.g. 9999" required pattern="\d{1,5}">
            </div>
            <div type="select" class="sdpi-item">
                <div class="sdpi-item-label">Presets</div>
                <select class="sdpi-item-value select presetSelector" onchange="sendMessageToPlugin(event.target.value, 'setPresetValue')">
                    <option value="">Retrieving Presets...</option>
                </select>
            </div>
            <div type="radio" class="sdpi-item" id="adjust_radio">
                <div class="sdpi-item-label">Recall To:</div>
                <div class="sdpi-item-value ">
                    <div class="sdpi-item-child">
                        <input id="rdio1" type="radio" value="preview" name="rdio" checked >
                        <label for="rdio1" class="sdpi-item-label"><span></span>Preview</label>
                    </div>
                    <div class="sdpi-item-child">
                        <input id="rdio2" type="radio" value="program" name="rdio">
                        <label for="rdio2" class="sdpi-item-label"><span></span>Program</label>
                    </div>
                </div>
            </div>
            <div class="sdpi-item">
                <div class="sdpi-item-label">Status</div>
                <div class="sdpi-item-value">
                    <span class="sdpi-item-child statusText">
                        Cannot detect Event Master on the the network
                    </span>
                </div>
            </div>


        </div>
        
        <script>
            var $localizedStrings = {};
            var pluginAction = null,
                uuid = '',
                context = '',
                connectionStatus = 'init',
                listOfCues = '',
                settings,
                cue_selected = "",
                appStatus = "disconnected",
                lang;
    
            
            if ($SD) {
                $SD.on('connected', function (jsonObj) {
                    //console.log(jsonObj);
                    uuid = jsonObj['uuid'];
                    lang = jsonObj.info.application.language;
    
                    /** Read Localization Strings */
    
                    Utils.readJson(`${lang}.json`, function (jsn) {
                        const manifest = Utils.parseJson(jsn);
                        $localizedStrings = manifest && manifest.hasOwnProperty('Localization') ? manifest['Localization'] : {};
                        localizeUI();
                    });
    
                    if (jsonObj['plugin']) {
                        pluginAction = jsonObj.plugin['action'];
                        context = jsonObj.plugin['context'];
    
                        sendMessageToPlugin('getData', "");
    
                    }
                });
    
                //TO TEST
                $SD.on('sendToPropertyInspector', (jsonObj) => messageFromPlugin(jsonObj));
    
            }
    
            /** you can also use ES6 syntax like so:
            *
            *   if ($SD) $SD.on('connected', (jsonObj) => { uuid=jsonObj.uuid }));
            *    
            */
            var cuelistener = document.querySelectorAll("input[type='radio']");
            cuelistener.addEventListener('change', function() {
                if (listOfCues != "") {
                    jsonData = listOfCues[this.value];
                    ReloadListOfCues(jsonData);
                }
            });

            
            function getIPAddress() {

                var value = document.querySelectorAll("input[id='ip_address']");
                
                return value;
            }

            function getPort() {

                var value = document.querySelectorAll("input[id='port']");
                
                return value;
            }

            function getCueListIndexSelected() {

                var value = null;
                var rad = document.querySelectorAll("input[type='radio']");
                //var prev = null;
                for(var i = 0; i < rad.length; i++) {
                    if (rad[i].checked) {
                        value = i;
                        break;
                    }
                }

                if (value == null) value = 0;

                return value;
            }

            function updateStatus() {
    
                console.log("updateStatus: " + appStatus);
    
                //show lists and selectors and hide download button
                const labelStatus = document.querySelector('.statusText');

                if (appStatus == "disconnected")
                    labelStatus.innerHTML = "Cannot detect Event Master on the network";

                else if (appStatus == "connected")
                    labelStatus.innerHTML = "Event Master is detected on the network";

                labelStatus.innerHTML = labelStatus.innerHTML.replace(labelStatus.innerText, localize(labelStatus.innerText));
            }
    
            function ReloadListOfCues(jsonListOfCues) {
    
                //remove all option list
                const oCuesSelector = document.querySelector(".cuesSelector");
                
                for(var i = oCuesSelector.options.length - 1 ; i >= 0 ; i--) {
                    oCuesSelector.remove(i);
                }
    
                var opt = document.createElement('option');
    
                opt.value = "";
                opt.innerHTML = "(Select a cue from the list)";
                oCuesSelector.appendChild(opt);
    
                //load the list of cues
                for (i = 0; i < jsonListOfCues.length; i++) {
                    opt = document.createElement('option');
    
                    opt.value = jsonListOfCues[i].cueID;
                    opt.innerHTML = jsonListOfCues[i].friendlyName;
    
                    //si recibimos una voz seleccionada la marcamos en el selector
                    if (cue_selected != "" && cue_selected == jsonListOfCues[i].cueID) {
                        opt.selected = true;
                    }
    
                    oCuesSelector.appendChild(opt);
                }
    
    
            }
    
            function messageFromPlugin(jsonObj) {
    
                console.log(jsonObj);
    
                if (jsonObj && jsonObj.payload && jsonObj.payload.command) {
    
                    if ( jsonObj.payload.command == "getData") {
                        
                        //get settings
                        if (jsonObj.payload.settings) {
                            var settings = jsonObj.payload.settings;
    
                            // IP Address
                            if (settings.hasOwnProperty("ip_address"))
                                ip_address  = settings.ip_address;

                            // Host
                            if (settings.hasOwnProperty("port"))
                                port  = settings.port;
                            
                            // Cues
                            if (settings.hasOwnProperty("cue_selected"))
                                cue_selected = settings.cue_selected;
                        }
    
                        //cues
                        if (jsonObj.payload.cues && jsonObj.payload.cues.actionObject) {
    
                            listOfCues = jsonObj.payload.cues.actionObject;
    
                            reloadListOfCues(listOfCues);
    
                            showHideFilterType("show");
                        }
    
                        //appStatus
                        if (jsonObj.payload.appStatus) {
                            appStatus = jsonObj.payload.appStatus;
    
                            updateStatus();
                        } 
    
                    }
    
                }
    
            }
    
    
            function sendMessageToPlugin(action, value) {
    
                //console.log("send Message to Plugin: ", action, value, uuid, pluginAction);
    
                if ($SD && $SD.connection) {
                    var payload = {};                
                    if (action) {
    
                        if (action == "setSettings") {
    
                           ip_address = payload["ip_address"] = getIPAddress();
                           port = payload["ip_address"] = getPort();
                           cue_selected = payload["cue_selected"] = value;
                           payload["command"] = action;
                        }
    
                        if (action == "getData") {
    
                            payload["command"] = action;
                        }
    
                        $SD.api.sendToPlugin(uuid, pluginAction, payload);
                    }
                }
            }
    
    
            function localize (s) {
                if (Utils.isUndefined(s)) return '';
                let str = String(s);
                try {
                    str = $localizedStrings[str] || str;
                } catch (b) {}
                return str;
            };
    
            function _e (s) {
                return localize(s);
            }
    
            function localizeUI() {
                const el = document.querySelector('.sdpi-wrapper');
                Array.from(el.querySelectorAll('sdpi-item-label')).forEach(e => {
                    e.innerHTML = e.innerHTML.replace(e.innerText, localize(e.innerText));
                });
                Array.from(el.querySelectorAll('*:not(script)')).forEach(e => {  
                    if (e.childNodes && e.childNodes.length > 0 && e.childNodes[0].nodeValue && typeof e.childNodes[0].nodeValue === 'string') {
                        e.childNodes[0].nodeValue = localize(e.childNodes[0].nodeValue);
                    }
                });
            }
            
            
        </script>
    </body>

    </html>
